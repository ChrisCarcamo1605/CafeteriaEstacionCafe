version: '3.8'

services:
  # Base de datos PostgreSQL (compartida)
  estacioncafedb:
    image: postgres:15-alpine
    container_name: estacioncafedb
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: estacionPass2025
      POSTGRES_DB: estacioncafedb
    ports:
      - "5555:5432"
    volumes:
      - db_data:/var/lib/postgresql/data
    networks:
      - estacioncafe_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d estacioncafedb"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Servicio de Machine Learning - FastAPI/Flask (debe iniciar después de DB)
  estacioncafe_ml:
    build:
      context: ../machinelearningcafeteria
      dockerfile: Dockerfile
    container_name: estacioncafe_ml
    environment:
      # Conectarse a la BD compartida
      DATABASE_URL: "postgresql://admin:estacionPass2025@estacioncafedb:5432/estacioncafedb"
      DB_HOST: estacioncafedb
      DB_PORT: 5432
      DB_USERNAME: admin
      DB_PASSWORD: estacionPass2025
      DB_NAME: estacioncafedb
    ports:
      - "8000:8000"  # Puerto del servicio ML
    volumes:
      - ../machinelearningcafeteria:/app
    depends_on:
      estacioncafedb:
        condition: service_healthy
    networks:
      - estacioncafe_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s=socket.socket(); s.connect((\"localhost\", 8000))' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  # API - Inicia después de DB y ML, ejecuta migraciones y seeds automáticamente
  estacioncafe_api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: estacioncafe_api
    environment:
      DB_HOST: estacioncafedb
      DB_PORT: 5432
      DB_USERNAME: admin
      DB_PASSWORD: estacionPass2025
      DB_NAME: estacioncafedb
      NODE_ENV: development
    ports:
      - "3484:3484"
    depends_on:
      estacioncafe_ml:
        condition: service_healthy
    networks:
      - estacioncafe_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3484 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s

  # Frontend - Inicia al final, después de que la API esté completamente lista
  estacioncafe_frontend:
    build:
      context: ../EstacionCafeFrontend
      dockerfile: Dockerfile
    container_name: estacioncafe_frontend
    environment:
      NODE_ENV: production
      # URL interna para que el frontend se comunique con la API dentro de la red docker
      API_URL: "http://estacioncafe_api:3484"
      PUBLIC_API_URL: "http://estacioncafe_api:3484"
    ports:
      - "3000:3000"  # Express server (puerto principal)
    volumes:
      # Persistir node_modules y dist
      - /app/node_modules
      - /app/dist
    depends_on:
      estacioncafe_api:
        condition: service_healthy
    networks:
      - estacioncafe_network
    restart: unless-stopped

volumes:
  db_data:

networks:
  estacioncafe_network:
    driver: bridge
